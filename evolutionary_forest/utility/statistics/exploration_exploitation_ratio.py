import numpy as np


def calculate_exploration_exploitation_ratio_fast(semantics_new, semantics_history, target_outputs, threshold=0.5):
    """
    Vectorized version to compute the Exploration/Exploitation ratio based on semantic similarity.

    Args:
        semantics_new (np.ndarray): New individuals' semantics, shape (N_new, T)
        semantics_history (np.ndarray): Historical individuals' semantics, shape (N_hist, T)
        target_outputs (np.ndarray): True output vector, shape (T,)
        threshold (float): Similarity threshold to distinguish exploration from exploitation

    Returns:
        float: Exploration/Exploitation ratio
        int: Number of exploratory individuals
        int: Number of exploitative individuals
    """
    if semantics_history.shape[0] == 0:
        return float('inf'), len(semantics_new), 0

    # Normalize factor (scalar)
    norm_factor = np.linalg.norm(target_outputs - np.mean(target_outputs))
    if norm_factor == 0:
        return 0.0, 0, 0

    # Compute all pairwise distances (broadcasting): shape (N_new, N_hist)
    dists = np.linalg.norm(semantics_new[:, None, :] - semantics_history[None, :, :], axis=2)

    # Find minimum distance to historical pool for each new individual
    min_dists = np.min(dists, axis=1)

    # Compute normalized distances (REud)
    reuds = min_dists / norm_factor

    # Vectorized classification
    exploration_mask = reuds > threshold
    exploitation_mask = (reuds > 0) & (reuds <= threshold)

    n_exploration = np.sum(exploration_mask)
    n_exploitation = np.sum(exploitation_mask)

    # Compute ratio
    if n_exploitation == 0:
        ratio = float('inf') if n_exploration > 0 else 0
    else:
        ratio = n_exploration / n_exploitation

    return ratio, int(n_exploration), int(n_exploitation)


if __name__ == '__main__':
    semantics_new = np.random.rand(50, 100)  # 50 new individuals
    semantics_history = np.random.rand(500, 100)  # 500 historical individuals
    target_outputs = np.random.rand(100)

    ratio, n_exp, n_expl = calculate_exploration_exploitation_ratio_fast(
        semantics_new, semantics_history, target_outputs
    )

    print(f"Exploration/Exploitation Ratio: {ratio:.2f} "
          f"(Exploration: {n_exp}, Exploitation: {n_expl})")
